---
layout: single
title: "SOCAR, 신규 쏘카존 제안"
categories: machine_learning
tags: [clustering, SARIMA, NDCG]
use_math: true
publish: false
author_profile: false
---

2022년 8월부터 2023년 2월까지 AIFFEL이라는 이름의 인공지능 교육과정에 참여했습니다.
이 포스트는 해당 과정의 최종 프로젝트에 대한 정리입니다.

카셰어링 업체 SOCAR로부터 45만여 건의 SOCAR 사용이력 데이터를 제공받았습니다.
그 중 다섯 건의 사용이력은 다음과 같습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\original_socar_data.png){: .img-75-center}

사용이력에 포함된 feature들은 각각 `지역1`(대지역), `지역2`(소지역), `대여시작시각`, `대여종료시각`, `나이대`, `성별`, `차종`입니다.

이 데이터(이하 `수요 데이터`)를 바탕으로 하여, 자유롭게 주제를 정하고, 유의미한 결과를 내는 것이 이 최종 프로젝트(AIFFELTHON)의 목표였습니다.
저희 팀은, `수요 데이터`를 바탕으로 하여 **신규 쏘카존의 위치를 제안**해보았습니다.

---

이 프로젝트에 대한 public 깃허브는 [이곳](https://github.com/govin08/our-socar)에 있습니다.
프로젝트의 상세한 진행사항은 [이곳](https://www.notion.so/modulabs/e9651dcbc43c4d0e95954ef1963426f1)에 기록되어 있습니다.

# 발표자료

![]({{site.url}}\images\2023-04-14-socar_zones\Slide1.PNG){: .img-100-center}

![]({{site.url}}\images\2023-04-14-socar_zones\Slide2.PNG){: .img-100-center}

발표자료의 목차입니다.
01과 02에서는 프로젝트의 전반적인 사항에 대해 대략적으로 이야기하고, 03부터 06까지는 네 단계에 걸쳐서 프로젝트의 진행상황을 적었습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\Slide3.PNG){: .img-100-center}

프로젝트의 배경 및 목적입니다.

저희 팀은 지역별로 쏘카의 이용 수에 차이가 있음을 먼저 관찰했습니다.
단순히 이용 수가 많고 적음을 넘어서서 이용 수가 증가세를 보이는지, 감소세를 보이는지 하는 것을 관찰할 수 있었습니다.
이러한 증감 경향을 지역별로 나누어 바라보는 것이 의미있을 것이라고 판단했습니다.

수요가 증가할 것으로 예상되는 지역과 감소할 것으로 예상되는 지역 중 저희 팀이 주목한 것은 수요가 증가할 것으로 예상되는 지역이었습니다.
수요가 증가할 것으로 예상되는 지역에 대해서는 새로운 쏘카존을 만들 필요가 있을 것입니다.
그리하여, 이번 프로젝트는 신규 쏘카존의 위치를 제안하는 것을 그 목표로 잡았습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\Slide4.PNG){: .img-100-center}

전체적인 프로젝트의 구조입니다.
프로젝트의 전체 내용을 한마디로 요약하면 다음과 같습니다.

*경기도 지역을 6개의 군집으로 나눈 후 각 군집별로 수요를 예측하여 미래에 수요가 증가할 것으로 예상되는 지역을 선정한 뒤, 해당 지역에 대하여 신규 쏘카존의 위치를 제안한다.*
{: .text-center}

프로젝트의 전체 과정은 네 단계로 나누어보았는데, 각각 '데이터 분석', '군집화', '수요예측', '신규존 제안' 입니다.
각각의 단계에 대한 설명은 다음과 같습니다.

 - 데이터 분석 : 군집화에서 사용할 feature들을 정한다.
 - 군집화 : k-means clustering을 통해 경기도 42개 지역을 6개 군으로 나눈다.
 - 수요예측 : 각 군들에 대하여 가장 수요가 증가할 것으로 예상되는 지역을 선정한다.
 - 신규존 제안 : 선정한 지역에 대하여 신규 쏘카존의 위치를 제안한다.

## 1 데이터 분석

![]({{site.url}}\images\2023-04-14-socar_zones\Slide5.PNG){: .img-100-center}

저희 팀은 수많은 지역들 중 경기도를 타겟으로 삼았습니다.
그 이유는, 제공받은 `수요 데이터` 대부분(77.96%)이 경기도의 데이터였기 때문이었는데요.
`수요 데이터`는 `지역1`(대지역) 기준으로 경기도, 울산광역시, 전라북도, 세종특별자치시, 부산광역시의 다섯 곳의 지역을 포함하고 있었습니다.
그 중 가장 많은 양의 데이터가 포함되어 있기도 하고, 지리적인, 그리고 행정적인 유사성을 따져보더라도, 경기도를 주요 관심지역으로 삼는 것이 가장 타당해보였습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\Slide6.PNG){: .img-100-center}

`수요 데이터` 중 경기도 지역 데이터는 `지역2`(소지역)을 기준으로 16개 소지역으로 나뉩니다.
그것들은
[시](https://ko.wikipedia.org/wiki/%EC%8B%9C_(%ED%96%89%EC%A0%95_%EA%B5%AC%EC%97%AD)),
[군](https://ko.wikipedia.org/wiki/%EB%8C%80%ED%95%9C%EB%AF%BC%EA%B5%AD%EC%9D%98_%EA%B5%B0),
[구](https://ko.wikipedia.org/wiki/%EB%8C%80%ED%95%9C%EB%AF%BC%EA%B5%AD%EC%9D%98_%EA%B5%AC)
를 의미합니다.
- 시(市) : 자치구를 따로 가지고 있지 않은 소도시 (e.g. 이천시, 포천시)
- 군(郡) : 시보다 규모가 작은 지역 (e.g. 양평군, 가평군)
- 구(區) : 자치구를 가지고 있는 대도시의 자치구(e.g. 수원시 팔달구, 수원시 만안구)

그런데 경기도의 시/군/구는 총 42개입니다.
그러니까 `수요 데이터`는 경기도의 모든 시/군/구의 데이터를 포함하고 있지 않습니다.
만약 42개 지역을 군집화하고, 16개 지역에 대한 수요들을 바탕으로 군집별 수요 증감을 예측한다면, 수요 정보가 없는 지역에 대해서도 수요의 증감을 간접적으로 예상할 수 있게 됩니다.

이것이 가능하려면 군집화가 '잘' 되어야 합니다.
카셰어링 수요를 잘 반영하는 군집화가 되어야 합니다.
다시 말해, 카셰어링 수요와 관련된 지역별 feature들을 잘 선정하고 그 feature들을 통해 군집화를 진행해야 합니다.

카셰어링 수요를 잘 반영하는 feature를 찾기 위해 먼저 논문들을 살폈습니다.
대표적으로 참고한 논문은 [서울시의 카셰어링 이용도에 대한 지역적 요인특성분석](https://www.dbpia.co.kr/journal/articleDetail?nodeId=NODE02497522)입니다.
이 논문의 결론을 읽어보면 어떤 지역이 업무중심지역이거나 역세권, 혹은 대학가이면 카셰어링 수요가 많다고 되어 있습니다.
또한 해당 지역이 주거지인지 여부 또한 카셰어링 수요에 영향을 미친다는 언급이 있습니다.
그밖에 대중교통이 용이한 지역이어도 카셰어링 수요가 많다는 것과 토지용도 또한 고려의 대상이 될 수 있다는 말들도 있습니다.

이러한 사항들을 바탕으로 하여 총 17종의 feature들을 선정하고, 경기도의 42개 지역에 대하여 해당 feature들에 대한 데이터를 모았습니다.
그리고 이 데이터를 `지역별 데이터`라고 명명했습니다.
수집한 feature들의 목록은 다음과 같습니다.
- `쏘카존 수`
- `인구`
- `2030인구`
- `아파트 수`
- `행복주택 수`
- `지하철역 수`
- `환승역 수`
- `버스정류장 수`
- `대학교 수`
- `대학생 수`
- `녹지`
- `주거`
- `공업`
- `상업`
- `위도`
- `경도`
- `면적`

위 feature들에 대한 상세한 설명은 다음과 같습니다.
- `인구`는 직접적으로 데이터를 얻을 수 있었으나, `2030인구`는 직접 데이터를 얻을 수는 없었습니다.
하지만 각 광역별(구를 가지고 있는 시별) 인구비율 데이터를 얻을 수 있었고, 이를 통해 `2030인구`를 간접적으로 구했습니다.
- feature들 중 수작업을 통해 데이터를 확보한 것은 `녹지`, `주거`, `공업`, `상업`입니다.
[지도](https://gris.gg.go.kr/)를 통해 살펴보며 해당 시/군/구의 하위행정구역(e.g. 동, 읍, 면)에 대하여 `녹지`, `주거`, `공업`, `상업` 중 하나의 토지용도를 결정했습니다.
해당 시/군/구의 `녹지` 데이터는 해당 시/군/구의 하위행정구역 중 얼마만큼의 비율의 하위행정구역이 `주거`인지를 나타냅니다.
예를 들어, 수원시 장안구의 경우 열 개의 동을 가지고 있고, 각각의 동들은

![]({{site.url}}\images\2023-04-14-socar_zones\landuse.png){: .img-40-center}

와 같은 토지용도를 가지고 있다면, 3개 동이 `녹지`이므로 수원시 장안구 지역의 `녹지`는 $\frac3{11}=0.2727$로 정합니다.
8개 동이 `주거`이므로 수원시 장안구 지역의 `주거`는 $\frac8{11}=0.7273$으로 정합니다.
그밖에 `공업`과 `상업`은 한번도 나타나지 않았으므로 각각 0입니다.
- `위도`와 `경도`, `면적`은 지리적인, 혹은 기하학적인 feature이므로 쏘카수요와 직접적으로 연관이 있다고 말할 수 없습니다.
이것들은 참고용으로, 혹은 대조군의 역할을 위해 구해놓은 것입니다.

이 17종의 feature들 중 `이용 수`(쏘카 사용량)와 상관성이 높은 열 개의 feature를 선별했습니다.
여기에서 '상관성'이라 함은 상관계수(pearson correlation coefficient)를 의미합니다.
(상관계수에 관해서는 블로그에 그 개념을 [정리](https://govin08.github.io/mathematics/kocw_stats/#13-상관계수와-연합확률분포)해본 바가 있습니다.)
또, `이용 수`는 지역별 쏘카 수요를 의미하는 것으로, `수요 데이터`로부터 손쉽게 얻을 수 있습니다.
17종의 feature에 대한 `이용 수`와의 상관계수는

![]({{site.url}}\images\2023-04-14-socar_zones\correlation.png){: .img-20-center}

와 같이 나타납니다.
이것은 몇가지 점에서 예상과는 조금 다릅니다.
아까 논문에서는 대학가에서 쏘카의 수요가 높을 것으로 보았습니다.
하지만, `대학 수`도, `대학생 수`도 `이용 수`와의 연관성이 낮은 것으로 나옵니다.
이것은 아마도, 최소 지역단위를 시/군/구로 잡았기 때문인 것으로 보입니다.
만약 더 세분화하여, 동/읍/면을 기준으로 데이터를 수집했다면 `대학 수`와 `대학생 수`는 '정상적'으로 `이용 수`와의 연관성이 높게 나타났을 수 있었을 것입니다.
또 한가지는, `대학 수`의 경우에 일반 4년제/2년제 대학은 물론, 소규모의 대학기관/대학원도 모두 포함시켜 얻은 데이터이기 때문에, 일반적으로 말하는 '대학가'의 개념과는 조금 다른 의미를 가지게 된 것인지도 모르겠습니다.
반대로, `경도`도 예상과는 다르게 `이용 수`와의 연관성이 높은 것으로 나옵니다.
이것은 경기도의 지리적 특성상, 경기도의 서쪽이 서울과 가깝고, 동쪽으로 갈 수록 서울과 멀어지는 것을 반영한 것으로 보입니다.

그밖의 점들에 있어서는 예상 범위 안의 결과를 보여줍니다.
`쏘카존 수`는 당연히 `이용 수`와 높은 상관관계를 보입니다.
`2030인구`, `인구`, `아파트 수`와 같은 **주거 특성의 feature**들은 예상대로 `이용 수`와 상관성이 있음이 나타납니다.
또한, `환승역 수`, `정류장 수`, `지하철역 수`와 같은 **교통 특성의 feature**들도 대체로 높은 상관성을 띠고 있습니다.
토지용도의 경우에는 `주거`와 `녹지`는 `이용 수`와 각각 양의 상관관계와 음의 상관관계를 보입니다.

아래의 두 그래프는 각각 `이용 수`와의 상관관계가 높은 `쏘카존 수`와 상관관계가 낮은 `대학교 수`와의 scatter plot입니다.

![]({{site.url}}\images\2023-04-14-socar_zones\correlation_scatter.png){: .img-75-center}

상관분석(Pearson correlation analysis)의 결과로 총 17개의 feature들 중 여섯 개의 feature를(`위도`, `경도`, `면적`, `대학교 수`, `대학생 수`, `행복주택 수`) 제거하여 11개의 feature들만을 남기게 됩니다;
- `쏘카존 수`
- `인구`
- `2030인구`
- `아파트 수`
- `지하철역 수`
- `환승역 수`
- `버스정류장 수`
- `녹지`
- `주거`
- `공업`
- `상업`

사실, 상관관계분석 말고도 선형회귀분석(linear regression analysis)도 해봤습니다.
하지만, 시간이 촉박하여 많은 결과를 도출해내지 못했고, 도출해냈다고 하더라도 그 결과를 신뢰하기 어려웠기 때문에 프로젝트의 전체흐름에 반영시키지 않았습니다.

## 2 군집화

![]({{site.url}}\images\2023-04-14-socar_zones\Slide7.PNG){: .img-100-center}

위에서 도출한 11개의 feature에 대한 `지역별 데이터`를 통해 경기도의 42개 지역을 군집화했습니다.
여러 군집화 방법 중 가장 기본적인 군집화 알고리즘인 K-means clustering을 사용했습니다.
이번 프로젝트에 관한 K-means clustering은 다음과 같이 서술될 수 있습니다.

`지역별 데이터`는 11개 feature에 대한 42개 지역 정보입니다.
그것을 11차원의 유클리드 공간에 놓인 42개의 점들 $\boldsymbol x_1$, $\boldsymbol x_2$, $\cdots$, $\boldsymbol x_{42}$ 이라고 생각할 수 있습니다.
이 42개의 점들을 $K$개의 군집 $S_1$, $S_2$, $\cdots$, $S_K$으로 묶습니다 ;

$$\{\boldsymbol x_1,\boldsymbol x_2,\cdots,\boldsymbol x_{42}\}=S_1\dot\cup S_2\dot\cup\cdots\dot\cup S_K$$

이때 묶는 방식은, 군집들이 각 군집의 무게중심(centroid, $\mu_k$)에 잘 뭉쳐지는 방식으로 묶는 것입니다.
다시 말해,

$$\sum_{k=1}^K\sum_{\boldsymbol x\in S_k}||\boldsymbol x-\mu_k||^2\tag{$(\ast)$}$$

이 최소화되도록 하는 군집 $S=\\{S_1, S_2, \cdots, S_{K}\\}$를 찾습니다.
이때, 최소화해야하는 위 식 $(\ast)$의 값을 distortion이라고도 부릅니다.
distortion의 최솟값을 $D(K)$라고 쓰면,

$$D(K)=\min_{S}\sum_{k=1}^K\sum_{\boldsymbol x_i\in S_k}||\boldsymbol x_i-\mu_k||^2$$

입니다.

이때, $K$의 값이 증가할 수록 $D(K)$의 값은 감소하는 것이 당연합니다.
한편, $D(K)$의 값이 작아지는 $K$값을 선정하는 것이 바람직하지만, 군집의 수(=K)가 너무 많아지면 군집화하는 의미가 별로 없습니다.
따라서, $D(K)$의 값이 처음으로 최솟값과 비슷한 값에 도달하는 $K$의 값, 다시 말해, $D(K)$의 그래프가 평평해지는 순간의 $K$를 선정하는 것이 가장 좋습니다.
$K$에 따른 $D(K)$의 그래프는

![]({{site.url}}\images\2023-04-14-socar_zones\elbow.png){: .img-80-center}

와 같이 나타납니다.
따라서, $K$값은 4,5,6,7,8 중의 하나의 값으로 선정하는 것이 적당해보입니다.

그러나, 언제나 그렇듯 군집의 수($K$)를 정하는 것은 애매한 일입니다.
$K=5$로 정하나, $K=6$으로 정하나, 아니면 $K=8$으로 정하나, distortion의 관점에서는 아주 큰 차이가 있다고 말할 수 없습니다.
하지만 군집화의 목적을 다시 한 번 상기해볼 필요가 있습니다.
군집화를 하는 이유는, 다음 단계인 '수요예측'에서 '수요가 증가할 것으로 예측되는 군'을 판별하기 위함입니다.

따라서, 실제 프로젝트에서는, 각각의 $K\in\\{4,5,6,7,8\\}$값들에 대하여 수요를 예측했을 때, 수요의 군별 증감이 뚜렷이 나타나는 $K$의 값으로 $K$를 정했습니다.
수요의 군별 증감이 가장 확연하게 나타나는 경우는 $K$가 6인 경우였기 때문에, $K=6$으로 그 값을 설정했습니다.
$K=6$으로 두어 경기도의 42개 시/군/구를 군집화한 결과는 아래와 같습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\Slide8.PNG){: .img-100-center}

![]({{site.url}}\images\2023-04-14-socar_zones\Slide9.PNG){: .img-100-center}

프로젝트의 최종 목표는 신규 쏘카존의 위치를 제안하는 것이지만, 위의 두 그림 역시 이번 프로젝트에서 얻을 수 있는 의미있는 중간 결과라고 할 수 있을 것입니다.
위의 두 그림은 카셰어링과 관련된 feature들을 통해, 42개의 지역을 특성별로 묶은 것입니다.
이에 관해서 아주 자세한 분석을 해본 것은 아닙니다.
그러니까, $K$값을 조금씩 변경하면서, 혹은 feature들의 조합을 조금씩 바꿔가면서 42개 지역의 군집화가 어떻게 변하는지를 살펴본다면, 조금 더 확실하고 엄밀한 결과를 얻어냈을 수도 있었을지 모릅니다.
하지만, 그 정도까지는 하지 않았고, 다만 두 개의 군집 $A$와 $D$에 대해서, 각 feature별 값(정확하게는 min-max scale된 값)을 살펴보았습니다.
예를 들어, $A$군의 `쏘카존 수`가 0.7403인 것은, 42개 시/군/구의 쏘카존 수 값

$$a_1, a_2,\cdots,a_{42}$$

을 minmax scaling하여

$$
\text{minmax}(a_i)=\frac{\max a_i-a_i}{a_i-\min a_i}
$$

를 얻고 ($1\le i\le42$)
이것을 다시 $A$군에 대해서만 평균낸 것입니다 ; 

$$\frac1{|S_1|}\sum_{\boldsymbol x_i\in S_1}\text{minmax}(a_i)=0.7403$$

$A$ 군의 경우 `지하철역 수`, `환승역 수`, `정류장 수`와 같은 **교통 특성의 feature**들과 `인구`, `2030인구`, `아파트 수`와 같은 **주거 특성의 feature**들이 비교적 높은 값을 보이고 있습니다.
다시 말해, 용인시 기흥구, 성남시 분당구, 시흥시, 김포시, 고양시 덕양구, 파주시, 의정부시와 같이 교통과 주거 측면에서 발달된 도시들끼리 뭉쳐서 $A$군을 이루었습니다.
반면, $D$군은 반대입니다.
`녹지`의 값이 크게 나타났을 뿐 다른 값들은 적은 값으로 표시되고 있습니다.
실제 지도에서도, $D$군을 이루는 양평군, 여주시, 과천시, 포천시, 동두천시, 가평군, 연천군 등은 경기도에서 상대적으로 도시화가 덜 진행된 지역들입니다.
이러한 지역들이 모여 $D$군을 이룬 것이 뚜렷이 보입니다.

`인구`, `2030인구`, `아파트 수`와 같은 **주거 특성의 feature**들은 예상대로 `이용 수`와 상관성이 있음이 나타납니다.
또한, `지하철역 수`, `환승역 수`, `정류장 수`와 같은 **교통 특성의 feature**들도 대체로 높은 상관성을 띠고 있습니다.

이 군집화의 결과를 이번에는 PCA를 통해 시각화해보았습니다.
즉, 두 개의 principal component들을 가지고 평면 위에 42개 점들을 찍으면, 그것들은 각기 색에 따라 잘 뭉쳐있는 것을 확인할 수 있습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\pca.png){: .img-70-center}

# 수요예측

이번에는 각각의 군들에 대하여 미래의 수요를 예측해봅니다.
여기에서 '미래'라고 함은, 주어진 `수요 데이터`의 시작시점은 2019년 1월 1일이고 종료시점은 2019년 11월 30일인데, 그 중 8:2의 시점에 해당하는 2019년 9월 25일을 '현재' 시점으로 잡고, 이 현재시점에 대한 미래 예측을 하는 것입니다.
조금 더 풀어서 설명하자면, `수요 데이터`는 45만 건의 쏘카 사용내역에 관한 데이터였고, 우리는 그 중 일부(77.96%)인 35만 건의 경기도의 쏘카 사용내역을 가지고 있습니다.
이것을 다섯 개의 군으로 나눕니다.
여섯 개의 군으로 나누지 못하는 이유는, $F$군의 경우 하나의 지역(평택시)으로 이루어져있는데, 그 평택시가 `수요 데이터`에 포함되지 않기 때문입니다.
여하튼, 그렇게 해서 얻은 다섯 개의 데이터를, 다시 일별로 잘라서, 다섯 개의 시간에 따른 수요 데이터를 얻습니다.

![]({{site.url}}\images\2023-04-14-socar_zones\timeseries.png){: .img-70-center}

이 다섯 개의 시계열 데이터를, 아까 언급한 대로 2019년 9월 25일을 현재 시점으로 설정하여, 과거 데이터들을 통해 학습하여 미래 데이터를 예측합니다.
예측에 사용한 모델은 두 종류로, baseline에 해당하는 linear model과 main model에 해당하는 SARIMA입니다.
linear model로 얻는 결과는

![]({{site.url}}\images\2023-04-14-socar_zones\linear_model.png){: .img-70-center}

와 같습니다.
사실 수요예측의 목적은 여섯 개의 군들 중 '미래에 수요가 증가할 것으로 예측되는'

![]({{site.url}}\images\2023-04-14-socar_zones\Slide10.PNG){: .img-100-center}

![]({{site.url}}\images\2023-04-14-socar_zones\Slide11.PNG){: .img-100-center}

![]({{site.url}}\images\2023-04-14-socar_zones\Slide12.PNG){: .img-100-center}

![]({{site.url}}\images\2023-04-14-socar_zones\Slide13.PNG){: .img-100-center}

![]({{site.url}}\images\2023-04-14-socar_zones\Slide14.PNG){: .img-100-center}